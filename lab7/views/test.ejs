<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpaceCream - Мороженое из Космоса</title>
    <!-- <link rel="stylesheet" href="css/style.css"> -->65
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://mystickermania.com/cdn/stickers/noob-pack/galaxy-ice-cream-512x512.png">
</head>
<body>
    
    <header>
        <a href="/">
            <h1>SpaceCream</h1>
        </a>
        <nav>
            <ul>
                <a href="#" onclick="showSection('catalog')">Каталог</a>
                <a href="/cart">Корзина</a>
                <% if (userPriority === 2) { %>
                    <a href="/admin">Админ-Панель</a>
                <% } %>

                <% if (userPriority === 1  || userPriority === 2) { %>
                    <a href="/logout"><%= userUsername %></a>
                    <%} else {%>
                        <a href="/login">Авторизация</a>
                    <% } %>
                

                <% if (cornerLetter === 'A') { %>
                    <div style="position: fixed; top: 10px; right: 10px; font-size: 24px; color: #fff;">A</div>
                <% } %>
                <!-- <a href="#" onclick="showSection('cart')">Корзина</a>
                <a href="#" onclick="showSection('profile')">Профиль</a>
                <a href="#" onclick="showSection('about')">О нас</a> -->
            </ul>
        </nav>
    </header>
    <!-- <div class="info__container"></div> -->
    
    <div class="container" id="catalog">
        <h2>Наши Космические Вкусы</h2>
        <% if (userPriority === 2) { %>
            <a id="editing-products" href="/admin/products">Добавить/Удалить</a>
        <% } %>
        <div class="ice-cream">
            <% products.forEach(product => { %>
                <div class="ice-cream-item">
                    <% if (product.image_url) { %>
                        <img src="<%= product.image_url %>" alt="<%= product.name %>" />
                    <% } %>
                    <h3><%= product.name %></h3>
                    <p><%= product.description %></p>
                    <p>Цена: <%= product.price %> руб.</p>
                    <form action="/cart" method="post">
                        <input type="hidden" name="product_id" value="<%= product.id %>">
                        <div class="quantity-control">
                            <input type="number" name="quantity" value="1" min="1" class="quantity-input">
                            <button type="button" class="decrease">−</button>
                            <button type="button" class="increase">+</button>
                        </div>
                        <a href="/product/<%= product.id %>/reviews">Посмотреть отзывы</a>
                        <button type="submit">Добавить в корзину</button>
                    </form>
                </div>
            <% }); %>
        </div>
    </div>
    <div class="container cart" id="cart">
        <h2>Ваша Космическая Корзина</h2>
        <div id="cart-items"></div>
        <p id="total-price">Итого: 0₽</p>
        <button onclick="checkout()">Оформить заказ</button>
    </div>
    
    <div class="container profile" id="profile">
        <h2>Ваш Космический Профиль</h2>
        <p>Имя: <span id="user-name"><%= userUsername || 'Пользователь' %></span></p>
        <button onclick="showEditForm()">Изменить профиль</button>

        <div id="edit-form" style="display: none;">
            <input type="text" id="new-name" placeholder="Введите новое имя" />
            <button onclick="updateProfile()">Сохранить</button>
            <button onclick="hideEditForm()">Отмена</button>
        </div>
    </div>
    
    <div class="container about" id="about">
        <h2>О Нас</h2>
        <p>Мы - команда, которая создает лучшее мороженое во Вселенной, используя только натуральные ингредиенты. Присоединяйтесь к нам в этом сладком космическом путешествии!</p>
    </div>
    
    <%- include('layout') %>


    
    <script>
    document.querySelectorAll('.quantity-control').forEach(control => {
        const decreaseButton = control.querySelector('.decrease');
        const increaseButton = control.querySelector('.increase');
        const quantityInput = control.querySelector('.quantity-input');

        decreaseButton.addEventListener('click', () => {
            let currentValue = parseInt(quantityInput.value);
            if (currentValue > 1) {
                quantityInput.value = currentValue - 1;
            }
        });

        increaseButton.addEventListener('click', () => {
            let currentValue = parseInt(quantityInput.value);
            quantityInput.value = currentValue + 1;
        });
    });

        let cart = [];
        let total = 0;
    
        function showSection(section) {
            document.querySelectorAll('.container').forEach((el) => {
                el.style.display = 'none';
            });
            document.getElementById(section).style.display = 'block';
            document.getElementById(section).style.animation = 'fadeIn 0.5s';
        }
    
        function addToCart(item, price) {
            cart.push({item, price});
            total += price;
            updateCart();
        }
    
        function updateCart() {
            const cartItemsContainer = document.getElementById('cart-items');
            cartItemsContainer.innerHTML = '';
    
            cart.forEach(cartItem => {
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `${cartItem.item} - ${cartItem.price}₽`;
                cartItemsContainer.appendChild(div);
            });
    
            document.getElementById('total-price').innerText = `Итого: ${total}₽`;
        }
    
        function showEditForm() {
    document.getElementById('edit-form').style.display = 'block'; // Показываем форму редактирования
}

function hideEditForm() {
    document.getElementById('edit-form').style.display = 'none'; // Скрываем форму редактирования
}

function updateProfile() {
    const newName = document.getElementById('new-name').value; // Получаем новое имя из поля ввода
    if (newName) {
        // Обновляем имя на странице
        document.getElementById('user-name').innerText = newName;

        // Отправляем AJAX-запрос для обновления в базе данных
        fetch('/update-profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ userId: userId, newName: newName }),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка при обновлении профиля');
            }
            return response.json();
        })
        .then(data => {
            console.log('Профиль обновлён:', data);
            hideEditForm(); // Скрываем форму после успешного обновления
        })
        .catch((error) => {
            console.error('Ошибка:', error);
        });
    } else {
        alert('Имя не может быть пустым!'); // Сообщение об ошибке
    }
}
    
        // Показать каталог по умолчанию
        showSection('catalog');
    
        // Функция для создания звезд
        function createStar() {
            const star = document.createElement('div');
            star.className = 'star';
            const size = Math.random() * 3 + 2; // Размер звезды
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;
            star.style.top = `${Math.random() * 100}vh`;
            star.style.left = `${Math.random() * 100}vw`;
            document.body.appendChild(star);
    
            // Анимация мигания
            star.style.animationDuration = `${Math.random() * 1 + 0.5}s`;
            star.style.opacity = Math.random();
    
            // Удаление звезды после анимации
            setTimeout(() => {
                star.remove();
            }, 1500);
        }
    
        // Создание звезд через каждые 200 мс
        setInterval(createStar, 100);
    </script>
</body>
</html>